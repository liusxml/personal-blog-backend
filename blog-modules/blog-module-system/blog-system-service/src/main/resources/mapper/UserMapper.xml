<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.blog.system.mapper.UserMapper">
    <!-- ============================================ -->
    <!-- Result Maps                                  -->
    <!-- ============================================ -->

    <!-- SysUser 结果映射 -->
    <resultMap id="BaseResultMap" type="com.blog.system.domain.entity.UserEntity">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="username" property="username" jdbcType="VARCHAR"/>
        <result column="nickname" property="nickname" jdbcType="VARCHAR"/>
        <result column="password" property="password" jdbcType="VARCHAR"/>
        <result column="email" property="email" jdbcType="VARCHAR"/>
        <result column="avatar" property="avatar" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="create_by" property="createBy" jdbcType="BIGINT"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_by" property="updateBy" jdbcType="BIGINT"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="INTEGER"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- SysRole 结果映射（用于关联查询）-->
    <resultMap id="RoleResultMap" type="com.blog.system.domain.entity.RoleEntity">
        <id column="role_id" property="id" jdbcType="BIGINT"/>
        <result column="role_name" property="roleName" jdbcType="VARCHAR"/>
        <result column="role_key" property="roleKey" jdbcType="VARCHAR"/>
        <result column="role_sort" property="roleSort" jdbcType="INTEGER"/>
        <result column="role_status" property="status" jdbcType="INTEGER"/>
        <result column="role_create_by" property="createBy" jdbcType="BIGINT"/>
        <result column="role_create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="role_update_by" property="updateBy" jdbcType="BIGINT"/>
        <result column="role_update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="role_is_deleted" property="isDeleted" jdbcType="INTEGER"/>
        <result column="role_version" property="version" jdbcType="INTEGER"/>
        <result column="role_remark" property="remark" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- ============================================ -->
    <!-- SQL Fragments（可复用SQL片段）              -->
    <!-- ============================================ -->

    <!-- 用户基础列 -->
    <sql id="Base_Column_List">
        id,
        username,
        nickname,
        password,
        email,
        avatar,
        status,
        create_by,
        create_time,
        update_by,
        update_time,
        is_deleted,
        version,
        remark
    </sql>

    <!-- 角色基础列（带别名，用于JOIN）-->
    <sql id="Role_Column_List">
        r.id          AS role_id,
        r.role_name   AS role_name,
        r.role_key    AS role_key,
        r.role_sort   AS role_sort,
        r.status      AS role_status,
        r.create_by   AS role_create_by,
        r.create_time AS role_create_time,
        r.update_by   AS role_update_by,
        r.update_time AS role_update_time,
        r.is_deleted  AS role_is_deleted,
        r.version     AS role_version,
        r.remark      AS role_remark
    </sql>

    <!-- ============================================ -->
    <!-- Custom Queries                               -->
    <!-- ============================================ -->

    <!--
    查询用户的角色列表
    优化点：
    1. 使用 XML 格式，SQL 更清晰易读
    2. 使用 resultMap 映射，避免字段重复
    3. 添加索引提示注释
    4. 明确指定所有字段，避免 SELECT *
    -->
    <select id="selectRolesByUserId" resultMap="RoleResultMap">
        SELECT
        <include refid="Role_Column_List"/>
        FROM sys_role r
        INNER JOIN sys_user_role ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId}
        AND r.is_deleted = 0
        AND r.status = 1
        ORDER BY r.role_sort ASC
    </select>

    <!--
    根据用户名查询用户（用于登录）
    优化点：
    1. 添加了 status 条件，只查询启用的用户
    2. 使用 LIMIT 1 优化性能
    3. 利用 idx_username 索引
    -->
    <select id="selectByUsername" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE username = #{username}
        AND is_deleted = 0
        LIMIT 1
    </select>

    <!--
    根据邮箱查询用户（用于登录）
    优化点：利用 idx_email 索引
    -->
    <select id="selectByEmail" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE email = #{email}
        AND is_deleted = 0
        LIMIT 1
    </select>

    <!--
    批量查询用户（用于 RemoteUserService）
    优化点：
    1. 使用 IN 查询
    2. 限制最大数量防止慢查询
    -->
    <select id="selectByIds" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
        LIMIT 100
    </select>

    <!--
    检查用户名是否存在（用于注册验证）
    优化点：只查询 COUNT，不返回完整数据
    -->
    <select id="existsByUsername" resultType="java.lang.Boolean">
        SELECT COUNT(1) > 0
        FROM sys_user
        WHERE username = #{username}
        AND is_deleted = 0
        LIMIT 1
    </select>

    <!--
    检查邮箱是否存在（用于注册验证）
    -->
    <select id="existsByEmail" resultType="java.lang.Boolean">
        SELECT COUNT(1) > 0
        FROM sys_user
        WHERE email = #{email}
        AND is_deleted = 0
        LIMIT 1
    </select>
</mapper>
